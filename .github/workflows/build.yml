name: Build YT Lite APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/audiobasics.jks

      - name: Inject app icon
        run: |
          pip install Pillow -q
          python3 << 'EOF'
          import base64, os
          from PIL import Image, ImageDraw
          import io

          sizes = {
              'mdpi': 48, 'hdpi': 72, 'xhdpi': 96,
              'xxhdpi': 144, 'xxxhdpi': 192
          }

          icon_b64 = """${{ secrets.APP_ICON_BASE64 }}"""

          for density, size in sizes.items():
              dir_path = f"app/src/main/res/mipmap-{density}"
              os.makedirs(dir_path, exist_ok=True)
              out_path = f"{dir_path}/ic_launcher.png"

              if icon_b64.strip():
                  try:
                      icon_data = base64.b64decode(icon_b64.strip())
                      img = Image.open(io.BytesIO(icon_data)).convert("RGBA")
                      resized = img.resize((size, size), Image.LANCZOS)
                      resized.save(out_path, "PNG")
                      print(f"Injected icon: {out_path}")
                      continue
                  except Exception as e:
                      print(f"Icon injection failed: {e}, using default")

              # Default icon â€” dark circle with white ring
              img = Image.new("RGBA", (size, size), (0, 0, 0, 255))
              draw = ImageDraw.Draw(img)
              margin = size // 8
              draw.ellipse([margin, margin, size - margin, size - margin],
                           outline=(255, 255, 255, 255), width=max(2, size // 16))
              inner = size // 3
              draw.ellipse([inner, inner, size - inner, size - inner],
                           fill=(255, 0, 0, 255))
              img.save(out_path, "PNG")
              print(f"Default icon created: {out_path}")
          EOF

      - name: Build signed release APK
        run: gradle assembleRelease
        env:
          KEYSTORE_PATH: audiobasics.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: audiobasics-apk
          path: app/build/outputs/apk/release/app-release.apk

name: Build YT Lite APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/audiobasics.jks

      - name: Inject app icon
        run: |
          cat > inject_icon.py << 'EOF'
          import base64, os, struct, zlib

          icon_b64 = "${{ secrets.APP_ICON_BASE64 }}"

          if not icon_b64:
              print("No icon secret found, skipping")
              exit(0)

          icon_data = base64.b64decode(icon_b64)

          sizes = {
              'mdpi': 48, 'hdpi': 72, 'xhdpi': 96,
              'xxhdpi': 144, 'xxxhdpi': 192
          }

          try:
              from PIL import Image
              import io
              img = Image.open(io.BytesIO(icon_data)).convert("RGBA")
              for density, size in sizes.items():
                  dir_path = f"app/src/main/res/mipmap-{density}"
                  os.makedirs(dir_path, exist_ok=True)
                  resized = img.resize((size, size), Image.LANCZOS)
                  resized.save(f"{dir_path}/ic_launcher.png", "PNG")
              print("Icons injected successfully")
          except ImportError:
              print("PIL not available, skipping icon injection")
          EOF
          pip install Pillow -q
          python inject_icon.py

      - name: Build signed APK
        run: gradle assembleRelease
        env:
          KEYSTORE_PATH: audiobasics.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: audiobasics-apk
          path: app/build/outputs/apk/release/app-release.apk
